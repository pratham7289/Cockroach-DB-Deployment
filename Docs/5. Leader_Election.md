
# CockroachDB Leader Election Test

This test verifies CockroachDB’s leader election (leaseholder selection) on a 3-pod cluster, ensuring automatic reassignment during node failure.

## Test Plan

### 1. Create Database and Table
```bash
kubectl exec -it cockroachdb-0 -n cockroachdb -- ./cockroach sql --insecure -e "CREATE DATABASE IF NOT EXISTS bank;"
kubectl exec -it cockroachdb-0 -n cockroachdb -- ./cockroach sql --insecure -d bank -e "
CREATE TABLE IF NOT EXISTS accounts (id INT PRIMARY KEY, balance DECIMAL);"
```
Sets up test environment.

### 2. Insert Data
```bash
kubectl exec -it cockroachdb-0 -n cockroachdb -- ./cockroach sql --insecure -d bank -e "
INSERT INTO accounts (id, balance) VALUES (1, 1000.00), (2, 1500.50), (3, 750.25), (4, 2100.00), (5, 300.00);"
```
Populates table to create ranges.

### 3. Verify Data
```bash
kubectl exec -it cockroachdb-0 -n cockroachdb -- ./cockroach sql --insecure -d bank -e "SELECT count(*) FROM accounts;"
```
Confirms 5 rows inserted.

### 4. Check Leaseholders
```bash
kubectl exec -it cockroachdb-0 -n cockroachdb -- ./cockroach sql --insecure -e "SELECT lease_holder, count(*) FROM crdb_internal.ranges GROUP BY lease_holder;"
```
Shows initial leaseholder distribution.

### 5. Simulate Node Failure
```bash
kubectl delete pod cockroachdb-1 -n cockroachdb
```
Triggers leader election by deleting a pod.

### 6. Re-check Leaseholders
```bash
kubectl exec -it cockroachdb-0 -n cockroachdb -- ./cockroach sql --insecure -e "SELECT lease_holder, count(*) FROM crdb_internal.ranges GROUP BY lease_holder;"
```
Verifies leases move to live nodes.

### 7. Monitor Pod Recovery
```bash
kubectl get pods -n cockroachdb -w
```
Confirms pod recreation and lease rebalancing.

---

## ✅ Results

- **Initial Leaseholders**: Distributed across nodes 1, 2, 3 (e.g., 22, 23, 19 ranges).
- **Post-Failure**: Leases redistributed to nodes 2, 3 (e.g., 33, 31 ranges).
- **Recovery**: Pod recreated, leases rebalanced across all nodes.
