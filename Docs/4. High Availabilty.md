

# CockroachDB High Availability (HA) Test

This test verifies CockroachDB’s high availability on a 3-pod cluster in k3s, ensuring queries remain available during node failure.

## Test Plan

### 1. Remove Test Data
```bash
kubectl exec -it -n cockroachdb cockroachdb-0 -- ./cockroach sql --insecure -e "DROP TABLE IF EXISTS test_ha;"
```
Clears previous test data.

### 2. Verify Cluster Health
```bash
kubectl exec -it -n cockroachdb cockroachdb-0 -- ./cockroach node status --insecure
```
Confirms all nodes are operational.

### 3. Check Replication
```bash
kubectl exec -it -n cockroachdb cockroachdb-0 -- ./cockroach sql --insecure -e "SHOW ZONE CONFIGURATION FOR DATABASE defaultdb;"
```
Verifies replication factor of 3.

### 4. Create and Populate Table
```bash
kubectl exec -it -n cockroachdb cockroachdb-0 -- ./cockroach sql --insecure -e "
CREATE TABLE test_ha (id INT PRIMARY KEY, name STRING);
INSERT INTO test_ha VALUES (1, 'test1'), (2, 'test2');
SELECT * FROM test_ha;"
```
Creates test table and inserts data.

### 5. Verify Replication
```bash
kubectl exec -it -n cockroachdb cockroachdb-0 -- ./cockroach sql --insecure -e "SHOW RANGES FROM TABLE test_ha;"
```
Confirms data is replicated across nodes.

### 6. Simulate Node Failure
```bash
kubectl delete pod -n cockroachdb cockroachdb-1
```
Deletes a pod to test HA.

### 7. Test Query Availability
```bash
kubectl exec -it -n cockroachdb cockroachdb-0 -- ./cockroach sql --insecure -e "
SELECT * FROM test_ha;
INSERT INTO test_ha VALUES (3, 'test3');
SELECT * FROM test_ha;"
```
Verifies reads and writes during failure.

### 8. Confirm Data Post-Recovery
```bash
kubectl exec -it -n cockroachdb cockroachdb-0 -- ./cockroach sql --insecure -e "SELECT * FROM test_ha;"
```
Ensures data integrity after pod recovery.

### 9. Check Admin UI
```bash
kubectl port-forward svc/cockroachdb-public -n cockroachdb 8080:8080
```
Access [http://localhost:8080](http://localhost:8080) to verify node status and replication.

---

## ✅ Results

- **Query Availability**: Reads and writes succeeded during failure.
- **Data Durability**: All data (id: 1-3, names: test1-test3) remained intact.
- **Node Recovery**: Operator recreated the pod, restoring full replication.
