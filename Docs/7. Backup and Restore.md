# CockroachDB Backup and Restore Test

This guide verifies **backup and restore functionality** on a 3-pod CockroachDB Kubernetes cluster using **nodelocal storage**.

---

## üß™ Test Plan

### 1Ô∏è‚É£ Create Backup

```bash
kubectl exec -it cockroachdb-0 -n cockroachdb -- ./cockroach sql --insecure --execute \
"BACKUP DATABASE bank INTO 'nodelocal://1/backup-bank';"
```

‚úÖ Backs up the `bank` database to Node 1‚Äôs local storage.

---

### 2Ô∏è‚É£ Verify Backup Files

```bash
kubectl exec -it cockroachdb-0 -n cockroachdb -- /bin/sh -c "ls /cockroach/cockroach-data/extern/backups/backup-bank"
```

‚úÖ Confirms that backup files exist on **Node 1**.

---

### 3Ô∏è‚É£ Restore Database

```bash
kubectl exec -it cockroachdb-0 -n cockroachdb -- ./cockroach sql --insecure --execute \
"RESTORE DATABASE bank FROM 'nodelocal://1/backup-bank';"
```

‚úÖ Restores the `bank` database from the backup.

---

### 4Ô∏è‚É£ Verify Restored Data

```bash
kubectl exec -it cockroachdb-0 -n cockroachdb -- ./cockroach sql --insecure -e "SELECT count(*) FROM bank.accounts;"
```

‚úÖ Verifies data integrity (e.g., expect **1,010,000 rows**).

---

## üìå Notes

- ‚ö†Ô∏è **Nodelocal Limitation:** Backups using `nodelocal://` are stored only on the individual node (Node 1). These are **not persistent** after pod deletion.
- üõ°Ô∏è In **production**, prefer external storage like **S3**, **GCS**, or **Persistent Volumes**.
- ‚úÖ **Verification Tips:**
  - Ensure the backup/restore job status shows **`succeeded`**.
  - Always validate data integrity post-restore.

---

## ‚úÖ Results Summary

| Step        | Result                                |
|-------------|----------------------------------------|
| Backup      | Successfully created on **Node 1**     |
| Restore     | Database restored with all data intact |
| Integrity   | **1,010,000** rows verified            |
